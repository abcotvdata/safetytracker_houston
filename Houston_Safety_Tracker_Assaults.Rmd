---
title: "ABC13 Neighborhood Safety Tracker"
# author: "John Kelly"
date: "Updated 4/26/2022 by the ABC13 Data Team"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(tidycensus)
library(readxl)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(sp)
library(sf)
library(htmlwidgets)
library(htmltools)

# rmarkdown::render('Houston_Safety_Tracker_2.Rmd', output_file = 'docs/Houston_Safety_Tracker_2.html')
```
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

```{css, echo=FALSE}

          
.title {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 45px;
    padding: 5px;
}

.date {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: center;
  font-size: 12px;
    padding: 5px;
}

select {
  margin: 0px;
  width: 175px;
  color: #00318b;
  padding: 5px 35px 5px 5px;
    font-family: roboto;
  font-size: 18px;
  font-weight: 900;
  border: 0px;
  height: 34px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Arrow-down.svg) 96% / 15% no-repeat #f2f2f2;
}

h1 {
  font-family: roboto;
  color: black;
  font-weight: bolder;
  text-align: left;
  font-size: 36px;
  margin-top: 0;
  margin-bottom: 0;
}

h2 {
  font-family: roboto;
  font-weight: 500;
  color: black;
  text-align: center;
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 2;
}

bignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 60px;
    line-height: 65px;
  height: 65px;
    margin-top: 0;
  margin-bottom: 0;
}

popupchatter {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 12px;
  margin-top: 0;
  margin-bottom: 2;
}

chartbignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: right;
  font-size: 36px;
    margin-top: 0;
  margin-bottom: 0;
}

subhead {
  font-family: roboto;
  color: black;
  font-weight: 700;
  text-align: left;
  font-size: 20px;
    padding: 0px;
}

body {
  color: black;
  font-family: roboto;
  font-weight: 400;
  font-size: 16px;
}

popuptitle {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: left;
  font-size: 20px;
    margin-top: 0;
  margin-bottom: 0;
}

h8 {
  color: #00318b;
  font-family: roboto;
  font-weight: 900;
  font-size: 16px;
}

table {
  font-family: roboto;
  border-collapse: collapse;
  width: 100%;
}

tr {
  border-bottom: thin solid #99a0a5;
}
  
td {
  text-align: right;
  padding: 6px;
}

th {
  text-align: right;
  padding: 6px;
}

   * {
      box-sizing: border-box;
   }
   .card {
      color: white;
      float: left;
      width: calc(25% - 20px);
      padding: 10px;
      border-radius: 10px;
      margin: 10px;
      height: 100%;
   }
   .card p {
   font-family: roboto;
   text-align: center;
   font-size: 14px;
  margin-bottom: 0;
   }
   .cardContainer:after {
      content: "";
      display: table;
      clear: both;
   }
   @media screen and (max-width: 650px) {
      .card {
         width: 100%;
      }

   }
```

```{r beats, include=FALSE}
# source("process_houston_police_beats.R")
```


```{r crimedata, include=FALSE}
# source("process_houston_crime_data.R")
```

<h2>ABC13's data team is tracking crime and safety across Houston and in your neighborhood.<br>You can choose which crime to examine: <select onchange="window.location=this.value">
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Assaults.html">Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker.html">Homicides</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_SexualAssaults.html">Sexual Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_AutoThefts.html">Auto Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Thefts.html">Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Burglaries.html">Burglaries</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Robberies.html">Robberies</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_DrugCrimes.html">Drug Crimes</option>
</select></h2>

<div class="cardContainer">
<div class="card" style="background-color:#99a0a5;">
<p>Assaults<br>
<bignumber>`r prettyNum(assaults_city$last12mos, big.mark=",")`<br></bignumber>
<p>Last 12 months<br>Through March 2022</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Average Assaults<br>
<bignumber>`r prettyNum(round(assaults_city$avg_prior3years,0), big.mark=",")`<br></bignumber><p>
Yearly average<br>2019 to 2021</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Assault Rate<br>
<bignumber>`r assaults_city$rate_last12`<br></bignumber><p>
Per 100,000 people<br>Last 12 months</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Average Assault Rate<br>
<bignumber>`r assaults_city$rate_prior3years`<br></bignumber><p>
Per 100,000 people<br>2019 to 2021</p>
</div>
</div>
<br>
Across Houston over the last 12 months, there were about <h8>`r round(assaults_city$last12mos/52,0)`</h8> assaults every week. In 2019, that number was <h8>`r round(assaults_city$total19/52,0)`</h8> per week.

About three years ago, the assault rate in Houston was <h8>`r assaults_city$rate19`</h8> per 100,000 residents. The average assault rate from 2019 to 2022 was <h8>`r assaults_city$rate_prior3years`</h8>. Last year, it was <h8>`r assaults_city$rate21`</h8>.

The danger, of course, is not the same neighborhood to neighborhood.

About <h8>`r round(pop_assaultsdown/2304580*100,0)`%</h8> of Houston residents live in neighborhoods where the assault rate over the last 12 months is down or about the same as the three-year average from 2019 through 2021. About <h8>`r round(pop_assaultsup/2304580*100,0)`%</h8> of residents live in neighborhoods where the assault rate is up more than 20% over the last 12 months.

<subhead>A closer look at Houston assaults neighborhood by neighborhood</subhead>

So, ABC13's data team looked at the Houston Police Department's data, beat by beat across the city to provide this look at trends by neighborhood from 2019 through last month.

The map color-codes each neighborhood by the assault rate over the last 12 months, through the end of March, which is the most recent comprehensive data released by the Houston Police Department.

The yellow areas are neighborhoods where the rate is among the 25% highest rates in the city. You can click on any neighborhood to see detailed figures, rates and trends.

ABC13 will be updating this data every month.


```{r cars, echo=FALSE,out.width='100%',out.height='600'}
# assault MAP

# Set bins for numbers of crimes for assaults map
assaultpal <- colorQuantile(c("#667f99",
                             "#00318b",
                             "#0058f6",
                             "#ffba00"), assaults_beat$rate_prior3years, n = 4, na.color = NA)

# Create quick labels for assaults map
assaultlabel <- paste(sep="",
"<table>
<popuptitle>Houston P.D. Beat #",
assaults_beat$beat,
"</popuptitle><br><popupchatter>Area neighborhoods and landmarks include ",
assaults_beat$placename,
". Estimated Population: ",
prettyNum(assaults_beat$population, big.mark=','),
"</popupchatter><br>
      <tr>
				<th></th>
				<th>Total</th>
				<th>Rate</th>
				<th>Trend</th>
			</tr>
			<tr>
				<td>2019</td>
				<td>",
assaults_beat$total19,
"</td>
				<td>",
assaults_beat$rate19,
"</td>
				<!-- Insert cell to cross/span 
				multi rows -->
				<td rowspan='5'>",
ifelse(assaults_beat$inc_prior3yearavgtolast12>=0,"Last 12<br>months up","Last 12<br>months down"),
"<br><chartbignumber>",
ifelse(assaults_beat$inc_prior3yearavgtolast12>=0,assaults_beat$inc_prior3yearavgtolast12,substring(assaults_beat$inc_prior3yearavgtolast12,2)),
				"%</chartbignumber><br>vs. 3-year<br>average</td>
			</tr>
			<tr>
				<td>2020</td>
				<td>",
assaults_beat$total20,
"</td>
				<td>",
assaults_beat$rate20,
"</td>
			</tr>
						<tr>
				<td>2021</td>
				<td>",
assaults_beat$total21,
"</td>
				<td>",
assaults_beat$rate21,
"</td>
			</tr>
						<tr>
				<td>Last 12 months</td>
				<td>",
assaults_beat$last12mos,
"</td>
				<td>",
assaults_beat$rate_last12,
"</td>
			</tr>
						<tr>
				<td>3-year Average</td>
				<td>",
assaults_beat$avg_prior3years,
"</td>
				<td>",
assaults_beat$rate_prior3years,
"</td>
			</tr>
</table>")

# Creating police beats map for types of crimes
houston_assault_map <- leaflet(assaults_beat, options = leafletOptions(zoomControl = FALSE)) %>%
  htmlwidgets::onRender("function(el, x) {
L.control.zoom({ position: 'topright' }).addTo(this)
}") %>%
  setView(-95.4, 29.75, zoom = 12) %>% 
  addProviderTiles(provider = "Stamen.TonerLite") %>%
  addPolygons(color = "white", 
              popup = assaultlabel, 
              weight = 0.5, 
              smoothFactor = 0.5,
              opacity = 0.6, 
              fillOpacity = 0.5,
              fillColor = ~assaultpal(rate_prior3years)) %>% 
  addLegend(opacity = 0.6,
            values = assaults_beat$rate_prior3years, 
            colors = c("#667f99",
                       "#00318b",
                       "#0058f6",
                       "#ffba00"),
            labels=c("Lowest Rate", 
                     "Lower Rate", 
                     "Higher Rate", 
                     "Highest Rate"),
            position = "bottomleft", 
            title = "Assaults<br>Per 100K people<br>") 

houston_assault_map
```
<br>
About <h8>`r round(pop_assaultsmonthly/2304580*100,0)`%</h8> of Houston residents now live in neighborhoods where there was at least one assault every month over the last year. Here's a look at citywide assaults every month since 2019.
<br>
<br>
<!-- <subhead>Assaults month by month, 2019 through last month</subhead> -->

<iframe title="Assaults month by month, 2019 through last month" aria-label="Column Chart" id="datawrapper-chart-DQ70W" src="https://datawrapper.dwcdn.net/DQ70W/2/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="400" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
  <br>
<br>
<!-- <subhead>Risk of assault and other crimes in Houston </subhead> -->

<iframe title="" aria-label="Dot Plot" id="datawrapper-chart-9SHHa" src="https://datawrapper.dwcdn.net/9SHHa/5/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="146" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>
<br>
