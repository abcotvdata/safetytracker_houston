---
title: "ABC13 Neighborhood Safety Tracker"
# author: "John Kelly"
date: "Updated 3/24/2022 by the ABC13 Data Team"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(tidycensus)
library(readxl)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(mapview)
library(sp)
library(sf)
library(htmlwidgets)
library(htmltools)

# rmarkdown::render('Houston_Safety_Tracker2.Rmd', output_file = 'docs/Houston_Safety_Tracker2.html')
```
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

```{css, echo=FALSE}

          
.title {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 45px;
    padding: 5px;
}

.date {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: center;
  font-size: 12px;
    padding: 5px;
}

h1 {
  font-family: roboto;
  color: black;
  font-weight: bolder;
  text-align: left;
  font-size: 36px;
  margin-top: 0;
  margin-bottom: 0;
}

h2 {
  font-family: roboto;
  font-weight: 500;
  color: black;
  text-align: center;
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 2;
}

h3 {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 70px;
    margin-top: 0;
  margin-bottom: 0;
}

h4 {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 10px;
  margin-top: 0;
  margin-bottom: 2;
}

h5 {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: right;
  font-size: 24px;
    margin-top: 0;
  margin-bottom: 0;
}

h6 {
  font-family: roboto;
  color: blue;
  text-align: left;
  font-size: 32px;
    margin-top: 0;
  margin-bottom: 0;
}

body {
  color: black;
  font-family: roboto;
  font-weight: 300;
  font-size: 8pt;
}

h7 {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: left;
  font-size: 16px;
    margin-top: 0;
  margin-bottom: 0;
}

h8 {
  color: white;
  background-color: #00318b;
  font-family: roboto;
  border-radius: 20px;
  padding: 2em;
  text-align: center;
}

h9 {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: left;
  font-size: 24px;
    padding: 5px;
}

table {
  font-family: roboto;
  border-collapse: collapse;
  width: 100%;
}

tr {
  border-bottom: thin solid #f2f2f2;
}
  
td {
  text-align: right;
  padding: 6px;
}

th {
  text-align: right;
  padding: 6px;
}

   * {
      box-sizing: border-box;
   }
   .card {
      color: white;
      float: left;
      width: calc(25% - 20px);
      padding: 10px;
      border-radius: 10px;
      margin: 10px;
      height: 160px;
   }
   .card p {
   font-family: roboto;
   text-align: center;
   font-size: 14px;
   }
   .cardContainer:after {
      content: "";
      display: table;
      clear: both;
   }
   @media screen and (max-width: 600px) {
      .card {
         width: 100%;
      }
   }
```


<h2>ABC 13 is tracking murders, and other crimes, across the city and in your neighborhood. Here's a look at what's happening with rising killings in the city.</h2>

<div class="cardContainer">
<div class="card" style="background-color:#99a0a5;">
<p>So far this year<br>
<h3>`r prettyNum(sum(murders_by_beat$total22), big.mark=",")`<br></h3><p>
people have been murdered.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>We are on track to reach<br></p>
<h3>`r prettyNum(sum(murders_by_beat$projected22), big.mark=",")`<br></h3>
<p>killings in 2022.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>That's more than the<br>
<h3>`r prettyNum(sum(murders_by_beat$total21), big.mark=",")`<br></h3><p>
murders in 2021.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>The murder rate would be <br>
<h3>`r round(sum(murders_by_beat$projected22)/2304580*100000,1)`<br></h3><p>
per 100,000 people in 2022.</p>
</div>
</div>
<br>
However, in the vast majority of neighborhoods in the city, the rate is much lower. In 17 of 118 of the Houston Police Department's, the murder rate was zero last year. In about half of the neighborhoods citywide, the murder rate is less than 10 per 100,000 residents - or less than half of the citywide rate.

ABC13 looked at the data, beat by beat across the city and is providing this look at the murder trends by neighborhood for each of the last four years in the map below.

The color-coding of the map is based on the murder rate over 2019, 2020, 2021 and 2022 so far, according to ABC13's analysis of data the Houston Police Department publishes every month online. This map will be updated monthly with the latest data as HPD publishes it.

```{r cars, echo=FALSE,out.width='100%',out.height='600'}
# MURDER MAP
# Set bins for numbers of crimes for murders map
murderbins <- c(0,median(murders_by_beat$rate_multiyear,na.rm = TRUE)/2,median(murders_by_beat$rate_multiyear,na.rm = TRUE),median(murders_by_beat$rate_multiyear,na.rm = TRUE)*2,median(murders_by_beat$rate_multiyear,na.rm = TRUE)*3,200)
murderpal <- colorBin(c("#99a0a5","#667f99","#00318b","#0058f6","#ffba00"), murders_by_beat$rate_multiyear, bins = murderbins)
# Create quick labels for murders map
murderlabel <- paste(sep="","<table>
<h7>Houston P.D. Beat #",
murders_by_beat$beat,
"</h7><br><h4>",
murders_by_beat$placename,
"<br>Estimated Population: ",prettyNum(murders_by_beat$population, big.mark=','),"</h4><br>
      <tr>
				<th>Year</th>
				<th>Total</th>
				<th>Rate</th>
				<th>Trend</th>
			</tr>
			<tr>
				<td>2019</td>
				<td>",
murders_by_beat$total19,
"</td>
				<td>",
murders_by_beat$rate19,
"</td>
				<!-- Insert cell to cross/span 
				multi rows -->
				<td rowspan='4'>",
ifelse(murders_by_beat$inc_3yearto22sofar>0,"Up","Down"),
"<br><h5>",
ifelse(murders_by_beat$inc_3yearto22sofar>0,murders_by_beat$inc_3yearto22sofar,substring(murders_by_beat$inc_3yearto22sofar,2)),
				"%</h5>vs. 3-year<br>average</td>
			</tr>
			<tr>
				<td>2020</td>
				<td>",
murders_by_beat$total20,
"</td>
				<td>",
murders_by_beat$rate20,
"</td>
			</tr>
						<tr>
				<td>2021</td>
				<td>",
murders_by_beat$total21,
"</td>
				<td>",
murders_by_beat$rate21,
"</td>
			</tr>
			</tr>
						<tr>
				<td>2022</td>
				<td>",
murders_by_beat$total22,
"</td>
				<td>",
murders_by_beat$rate22,
"</td>
			</tr>
</table>")

# Create rapid prototype of murders map
# Issue to fix here is that we merged the data points to the df first, instead of the spatial file
# Go back and rework that part
houston_murder_map <- leaflet(murders_by_beat, options = leafletOptions(zoomControl = FALSE)) %>%
  htmlwidgets::onRender("function(el, x) {
L.control.zoom({ position: 'topright' }).addTo(this)
}") %>%
  setView(-95.4, 29.75, zoom = 12) %>% 
  addProviderTiles(provider = "Stamen.TonerLite") %>%
  addPolygons(color = "white", popup = murderlabel, weight = 0.5, smoothFactor = 0.5,
              opacity = 0.6, fillOpacity = 0.5,
              fillColor = ~murderpal(rate_multiyear)) %>% 
  addLegend(pal = murderpal, 
            opacity = 0.6,
            values = murders_by_beat$rate_multiyear, 
            position = "bottomleft", 
            title = "Homicides<br>Per 100K people<br>") 
#  addLegend(position = "topleft", 
#            labels = NULL,
#            values = NULL,
#            colors = NULL,
#            title = "<big>World's Best Map of Houston Homicides</big><br>
#            <small>Please insert some chatter & other html/tools/stuff here<br>
#See also: <a href='https://abcotvdata.github.io/safetytracker_houston/sexualassault_rate.html'>Sexual Assault</a> |
# <a href='https://abcotvdata.github.io/safetytracker_houston/autothefts_rate.html'>Auto #Thefts</a> |
#              <a href='https://abcotvdata.github.io/safetytracker_houston/autothefts_rate.html'>Burglaries</a>  |
#              <a href='https://abcotvdata.github.io/safetytracker_houston/autothefts_rate.html'>Theft</a></small>")

houston_murder_map
```

However, in the vast majority of neighborhoods in the city, the rate is much lower. In 17 of 118 of the Houston Police Department's, the murder rate was zero last year. Filler, filler, filler.

<h9>Homicides by neighborhood (placeholder table)</h9>

<iframe title="Houston Neighborhood Crime Test Table" aria-label="Table" id="datawrapper-chart-T23TE" src="https://datawrapper.dwcdn.net/T23TE/6/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="732" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
  
<h9>What kinds of places do murders happen in Houston (placeholder table)</h9>

<iframe title="Houston Neighborhood Crime Test Table" aria-label="Table" id="datawrapper-chart-T23TE" src="https://datawrapper.dwcdn.net/T23TE/6/?search=Murder" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="732" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>

<h9>When do murders happen (placeholder table)</h9>

<iframe title="Houston Neighborhood Crime Test Table" aria-label="Table" id="datawrapper-chart-T23TE" src="https://datawrapper.dwcdn.net/T23TE/6/?search=Kidnapping" scrollings="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="732" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>


<div class="cardContainer">
<div class="card" style="background-color:#99a0a5;">
<p>So far this year<br>
<h3>`r prettyNum(sum(murders_by_beat$total22), big.mark=",")`<br></h3><p>
people have been murdered.</p>
</div>
<div class="card" style="background-color:#667f99;">
<p>We are on track to reach<br></p>
<h3>`r prettyNum(sum(murders_by_beat$projected22), big.mark=",")`<br></h3>
<p>killings in 2022.</p>
</div>
<div class="card" style="background-color:#0d1721;">
<p>That's more than the<br>
<h3>`r prettyNum(sum(murders_by_beat$total21), big.mark=",")`<br></h3><p>
murders in 2021.</p>
</div>
<div class="card" style="background-color:#f2f2f2; color:black;">
<p>The murder rate would be <br>
<h3>`r round(sum(murders_by_beat$projected22)/2304580*100000,1)`<br></h3><p>
per 100,000 people in 2022.</p>
</div>
</div>
<br>
