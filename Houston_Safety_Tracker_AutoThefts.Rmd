---
title: "ABC13 Neighborhood Safety Tracker"
# author: "John Kelly"
date: "Updated 4/6/2022 by the ABC13 Data Team"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(tidycensus)
library(readxl)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(sp)
library(sf)
library(htmlwidgets)
library(htmltools)

# rmarkdown::render('Houston_Safety_Tracker_2.Rmd', output_file = 'docs/Houston_Safety_Tracker_2.html')
```
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

```{css, echo=FALSE}

          
.title {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 45px;
    padding: 5px;
}

.date {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: center;
  font-size: 12px;
    padding: 5px;
}

select {
  margin: 0px;
  width: 150px;
  color: #00318b;
  padding: 5px 35px 5px 5px;
    font-family: roboto;
  font-size: 18px;
  font-weight: 900;
  border: 0px;
  height: 34px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Arrow-down.svg) 96% / 15% no-repeat #f2f2f2;
}

h1 {
  font-family: roboto;
  color: black;
  font-weight: bolder;
  text-align: left;
  font-size: 36px;
  margin-top: 0;
  margin-bottom: 0;
}

h2 {
  font-family: roboto;
  font-weight: 500;
  color: black;
  text-align: center;
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 2;
}

bignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 80px;
    line-height: 85px;
  height: 85px;
    margin-top: 0;
  margin-bottom: 0;
}

popupchatter {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 12px;
  margin-top: 0;
  margin-bottom: 2;
}

chartbignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: right;
  font-size: 36px;
    margin-top: 0;
  margin-bottom: 0;
}

subhead {
  font-family: roboto;
  color: black;
  font-weight: 700;
  text-align: left;
  font-size: 20px;
    padding: 0px;
}

body {
  color: black;
  font-family: roboto;
  font-weight: 400;
  font-size: 16px;
}

popuptitle {
  font-family: roboto;
  color: #00318b;
  font-weight: bolder;
  text-align: left;
  font-size: 20px;
    margin-top: 0;
  margin-bottom: 0;
}

h8 {
  color: #00318b;
  font-family: roboto;
  font-weight: 900;
  font-size: 16px;
}

table {
  font-family: roboto;
  border-collapse: collapse;
  width: 100%;
}

tr {
  border-bottom: thin solid #99a0a5;
}
  
td {
  text-align: right;
  padding: 6px;
}

th {
  text-align: right;
  padding: 6px;
}

   * {
      box-sizing: border-box;
   }
   .card {
      color: white;
      float: left;
      width: calc(25% - 20px);
      padding: 10px;
      border-radius: 10px;
      margin: 10px;
      height: 100%;
   }
   .card p {
   font-family: roboto;
   text-align: center;
   font-size: 12px;
  margin-bottom: 0;
   }
   .cardContainer:after {
      content: "";
      display: table;
      clear: both;
   }
   @media screen and (max-width: 650px) {
      .card {
         width: 100%;
      }

   }
```

```{r beats, include=FALSE}
# source("process_houston_police_beats.R")
```


```{r crimedata, include=FALSE}
# source("process_houston_crime_data.R")
```

<h2>ABC13's data team is tracking crime and safety across Houston and in your neighborhood.<br>You can choose which crime to examine: <select onchange="window.location=this.value">
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_AutoThefts.html">Auto Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_SexualAssaults.html">Sexual Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker.html">Homicides</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Assaults.html">Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Thefts.html">Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Burglaries.html">Burglaries</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Robberies.html">Robberies</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_DrugCrimes.html">Drug Crimes</option>
</select></h2>

<div class="cardContainer">
<div class="card" style="background-color:#99a0a5;">
<p>So far this year<br>
<bignumber>`r prettyNum(autothefts_city$total22, big.mark=",")`<br></bignumber><p>
vehicles have been stolen.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Over the last 12 months,<br>
<bignumber>`r prettyNum(autothefts_city$last12mos, big.mark=",")`<br></bignumber>
<p>vehicles have been stolen.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>The yearly average is<br>
<bignumber>`r prettyNum(round(autothefts_city$avg_prior3years,0), big.mark=",")`<br></bignumber><p>
from 2019 to 2021.</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>The auto theft rate is <br>
<bignumber>`r autothefts_city$rate_last12`<br></bignumber><p>
per 100K people the last year.</p>
</div>
</div>
<br>
About three years ago, the auto theft rate in Houston was <h8>`r autothefts_city$rate19`</h8> per 100,000 residents. During the pandemic years, the risk of auto theft in Houston rose at a sharp pace. The average auto theft rate for the three-year period from 2019 to 2022 was <h8>`r autothefts_city$rate_prior3years`</h8> and last year it was <h8>`r autothefts_city$rate21`</h8>.

Across the city the last 12 months, there were about <h8>`r round(autothefts_city$last12mos/52,1)`</h8> vehicles stolen every week. In 2019, that number was <h8>`r round(autothefts_city$total19/52,1)`</h8> per week.

The situation, of course, is not the same neighborhood to neighborhood.

About <h8>`r round(pop_autotheftsdown/2304580*100,0)`%</h8> of city residents live in neighborhoods where the auto theft rate over the last 12 months is down or about the same as the three-year average. 

In fact, <h8>`r round(pop_autotheftszero/2304580*100,0)`%</h8> of people live in neighborhoods where there were no auto thefts at all over the last 12 months.

But, about <h8>`r round(pop_autotheftsup/2304580*100,0)`%</h8> of Houston residents live in neighborhoods where the auto theft rate is up more than 20% in the last 12 months when compared to the three-year average from 2019 to 2021.

And, <h8>`r round(pop_autotheftsmonthly/2304580*100,0)`%</h8> of us now live in neighborhoods where there was at least one auto theft every month over the last year.

<subhead>Houston homicides neighborhood by neighborhood</subhead>

ABC13 looked at the Houston Police Department's data, beat by beat across the city and is providing this look at the auto theft trends by neighborhood for each of the last four years in the map below. The color-coding of the map is based on the auto theft rate over 2019, 2020 and 2021 combined, according to ABC13's analysis of data the city police department publishes monthly.

```{r cars, echo=FALSE,out.width='100%',out.height='600'}
# autotheft MAP

# Set bins for numbers of crimes for autothefts map
autotheftpal <- colorQuantile(c("#667f99",
                             "#00318b",
                             "#0058f6",
                             "#ffba00"), autothefts_beat$rate_prior3years, n = 4, na.color = NA)

# Create quick labels for autothefts map
autotheftlabel <- paste(sep="",
"<table>
<popuptitle>Houston P.D. Beat #",
autothefts_beat$beat,
"</popuptitle><br><popupchatter>Area neighborhoods and landmarks include ",
autothefts_beat$placename,
". Estimated Population: ",
prettyNum(autothefts_beat$population, big.mark=','),
"</popupchatter><br>
      <tr>
				<th></th>
				<th>Total</th>
				<th>Rate</th>
				<th>Trend</th>
			</tr>
			<tr>
				<td>2019</td>
				<td>",
autothefts_beat$total19,
"</td>
				<td>",
autothefts_beat$rate19,
"</td>
				<!-- Insert cell to cross/span 
				multi rows -->
				<td rowspan='5'>",
ifelse(autothefts_beat$inc_prior3yearavgtolast12>=0,"Last 12<br>months up","Last 12<br>months down"),
"<br><chartbignumber>",
ifelse(autothefts_beat$inc_prior3yearavgtolast12>=0,autothefts_beat$inc_prior3yearavgtolast12,substring(autothefts_beat$inc_prior3yearavgtolast12,2)),
				"%</chartbignumber><br>vs. 3-year<br>average</td>
			</tr>
			<tr>
				<td>2020</td>
				<td>",
autothefts_beat$total20,
"</td>
				<td>",
autothefts_beat$rate20,
"</td>
			</tr>
						<tr>
				<td>2021</td>
				<td>",
autothefts_beat$total21,
"</td>
				<td>",
autothefts_beat$rate21,
"</td>
			</tr>
						<tr>
				<td>Last 12 months</td>
				<td>",
autothefts_beat$last12mos,
"</td>
				<td>",
autothefts_beat$rate_last12,
"</td>
			</tr>
						<tr>
				<td>3-year Average</td>
				<td>",
autothefts_beat$avg_prior3years,
"</td>
				<td>",
autothefts_beat$rate_prior3years,
"</td>
			</tr>
</table>")

# Creating police beats map for types of crimes
houston_autotheft_map <- leaflet(autothefts_beat, options = leafletOptions(zoomControl = FALSE)) %>%
  htmlwidgets::onRender("function(el, x) {
L.control.zoom({ position: 'topright' }).addTo(this)
}") %>%
  setView(-95.4, 29.75, zoom = 12) %>% 
  addProviderTiles(provider = "Stamen.TonerLite") %>%
  addPolygons(color = "white", 
              popup = autotheftlabel, 
              weight = 0.5, 
              smoothFactor = 0.5,
              opacity = 0.6, 
              fillOpacity = 0.5,
              fillColor = ~autotheftpal(rate_prior3years)) %>% 
  addLegend(opacity = 0.6,
            values = autothefts_beat$rate_prior3years, 
            colors = c("#667f99",
                       "#00318b",
                       "#0058f6",
                       "#ffba00"),
            labels=c("Lowest Rate", 
                     "Lower Rate", 
                     "Higher Rate", 
                     "Highest Rate"),
            position = "bottomleft", 
            title = "Homicides<br>Per 100K people<br>") 

houston_autotheft_map
```

However, in the vast majority of neighborhoods in the city, the rate is much lower. In 17 of 118 of the Houston Police Department's, the autotheft rate was zero last year. Filler, filler, filler.
<br>
<br>
<!-- <subhead>Homicides month by month, 2019 through last month</subhead> -->

<iframe title="Homicides month by month, 2019 through last month" aria-label="Column Chart" id="datawrapper-chart-3NHzG" src="https://datawrapper.dwcdn.net/3NHzG/5/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="400" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
  <br>
<br>
<!-- <subhead>Risk of being autothefted in Houston vs. other causes of death in Texas</subhead> -->

<iframe title="" aria-label="Dot Plot" id="datawrapper-chart-9SHHa" src="https://datawrapper.dwcdn.net/9SHHa/5/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="146" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>
<br>
<!-- <subhead>What kinds of places do autothefts happen in Houston</subhead> -->

<iframe title="What kinds of places do murders happen in Houston"  aria-label="Table" id="datawrapper-chart-xI2y0" src="https://datawrapper.dwcdn.net/xI2y0/10/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="1239" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>
<br>
<!-- <subhead>What time of day do autothefts happen?</subhead> -->

<iframe title="What hour of day do murders happen" aria-label="Column Chart" id="datawrapper-chart-coxAA" src="https://datawrapper.dwcdn.net/coxAA/7/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="400" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
