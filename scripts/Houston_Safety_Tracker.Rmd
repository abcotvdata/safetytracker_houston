---
title: "ABC13 Neighborhood Safety Tracker"
# author: "John Kelly"
date: "Updated `r format(Sys.time(), '%B %d, %Y')` by the ABC13 Data Team"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(tidycensus)
library(readxl)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(sp)
library(sf)
library(htmlwidgets)
library(htmltools)

# rmarkdown::render('Houston_Safety_Tracker_2.Rmd', output_file = 'docs/Houston_Safety_Tracker_2.html')
```
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

```{css, echo=FALSE}

          

          
.title {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 45px;
    padding: 5px;
}

.date {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: center;
  font-size: 12px;
    padding: 5px;
}

select {
  margin: 0px;
  width: 180px;
  color: #00318b;
  padding: 5px 35px 5px 5px;
    font-family: roboto;
  font-size: 18px;
  font-weight: 900;
  border: 0px;
  height: 34px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background: url(https://upload.wikimedia.org/wikipedia/commons/9/9d/Arrow-down.svg) 96% / 15% no-repeat #f2f2f2;
}

h1 {
  font-family: roboto;
  color: black;
  font-weight: bolder;
  text-align: left;
  font-size: 36px;
  margin-top: 0;
  margin-bottom: 0;
}

h2 {
  font-family: roboto;
  font-weight: 500;
  color: black;
  text-align: center;
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 2;
}

bignumber {
  font-family: roboto;
  color: #00318b;
  font-weight: 900;
  text-align: center;
  font-size: 60px;
    line-height: 65px;
  height: 65px;
    margin-top: 0;
  margin-bottom: 0;
}

subhead {
  font-family: roboto;
  color: black;
  font-weight: 700;
  text-align: left;
  font-size: 20px;
    padding: 0px;
}

body {
  color: black;
  font-family: roboto;
  font-weight: 400;
  font-size: 18px;
}

popuptitle {
  color: #00318b;
  font-family: roboto;
  font-weight: 700;
  font-size: 15px;
  text-align: left;
}

popupchatter {
  font-family: roboto;
  color: black;
  font-weight: 300;
  text-align: left;
  font-size: 12px;
  margin-top: 0;
  margin-bottom: 2;
}

h8 {
  color: #00318b;
  font-family: roboto;
  font-weight: 900;
  font-size: 18px;
}

table {
  font-family: roboto;
  width: 100%;
}

tr {
  border-bottom: thin solid #99a0a5;
}
  
td {
  text-align: right;
  padding: 1px;
}

th {
  text-align: right;
  padding: 1px;
}

   * {
      box-sizing: border-box;
   }
   .card {
      color: white;
      float: left;
      width: calc(25% - 20px);
      padding: 10px;
      border-radius: 10px;
      margin: 10px;
      height: 100%;
   }
   .card p {
   font-family: roboto;
   text-align: center;
   font-size: 14px;
  margin-bottom: 0;
   }
   .cardContainer:after {
      content: "";
      display: table;
      clear: both;
   }
   @media screen and (max-width: 650px) {
      .card {
         width: 100%;
      }

   }
```

```{r beats, include=FALSE}
# source("process_houston_police_beats.R")
```


```{r crimedata, include=FALSE}
# source("process_houston_crime_data.R")
```

<h2>ABC13 is tracking crime and safety across Houston and in your neighborhood. Choose which crime to explore: <select onchange="window.location=this.value">
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker.html">Homicides</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Assaults.html">Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_AutoThefts.html">Auto Thefts</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Burglaries.html">Burglaries</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_DrugCrimes.html">Drug Crimes</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker.html">Homicides</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Robberies.html">Robberies</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_SexualAssaults.html">Sexual Assaults</option>
<option value="https://abcotvdata.github.io/safetytracker_houston/Houston_Safety_Tracker_Thefts.html">Thefts</option>
</select></h2>

<div class="cardContainer">
<div class="card" style="background-color:#99a0a5;">
<p>Homicides<br>
<bignumber>`r prettyNum(murders_city$last12mos, big.mark=",")`<br></bignumber>
<p>Last 12 months<br>Through April 2022</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Average Homicides<br>
<bignumber>`r prettyNum(round(murders_city$avg_prior3years,0), big.mark=",")`<br></bignumber><p>
Yearly average<br>2019 to 2021</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Homicide Rate<br>
<bignumber>`r murders_city$rate_last12`<br></bignumber><p>
Per 100,000 people<br>Last 12 months</p>
</div>
<div class="card" style="background-color:#99a0a5;">
<p>Average Homicide Rate<br>
<bignumber>`r murders_city$rate_prior3years`<br></bignumber><p>
Per 100,000 people<br>2019 to 2021</p>
</div>
</div>
<br>
Homicides are <h8>`r ifelse(murders_city$inc_prior3yearavgtolast12>=0," up"," down")` `r ifelse(murders_city$inc_prior3yearavgtolast12>=0,murders_city$inc_prior3yearavgtolast12,substring(murders_city$inc_prior3yearavgtolast12,2))`%</h8> over the last 12 months compared to the average from 2019-2021.

The city averaged <h8>`r round(murders_city$last12mos/52,0)`</h8> homicides a week since last May. In 2019, that number was <h8>`r round(murders_city$total19/52,0)`</h8> a week.

One way to think about the danger: three years ago, the murder rate was <h8>`r murders_city$rate19`</h8> per 100,000 residents, about the same as the rate of being killed in a vehicle crash in Texas. During the pandemic, a person's chance of being murdered here rose well above the likelihood of dying in a vehicle crash.
<br>
<br>
<!-- <subhead>Risk of being murdered in Houston vs. other causes of death in Texas</subhead> -->

<iframe title="" aria-label="Dot Plot" id="datawrapper-chart-9SHHa" src="https://datawrapper.dwcdn.net/9SHHa/8/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="146" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>

The risk is not the same neighborhood to neighborhood.

About <h8>`r round(pop_murdersup/2304580*100,0)`%</h8> of people live in neighborhoods where the murder rate is up 20% or more over the last 12 months compared to the average from 2019-2021.

ABC13's data team looked at the Houston Police Department's data by neighborhood from 2019 through last month.

<subhead>A closer look at Houston homicides neighborhood by neighborhood</subhead>

The map color-codes each neighborhood by the homicide rate over the last 12 months. Yellow areas are neighborhoods where the homicide rate is among the 25% highest in the city.

Click on any neighborhood on the map to see detailed figures, rates and trends. You can also search for a street name, place, landmark or zip code.

<br>
```{r cars, echo=FALSE,out.width='100%',out.height='600'}
# MURDER MAP

# Set bins for numbers of crimes for murders map
murderpal <- colorQuantile(c("#667f99",
                             "#00318b",
                             "#0058f6",
                             "#ffba00",
                             "#be0000"), murders_beat$rate_last12, n = 5, na.color = NA)

# Create quick labels for murders map
murderlabel <- paste(sep="",
ifelse(murders_beat$inc_prior3yearavgtolast12>=0,
       "<popuptitle>Homicides are up ",
       "<popuptitle>Homicides are down "),
ifelse(murders_beat$inc_prior3yearavgtolast12>=0,murders_beat$inc_prior3yearavgtolast12,substring(murders_beat$inc_prior3yearavgtolast12,2)),
				"%</popuptitle><br><popupchatter>the last 12 months vs. the 3-year average in the area including ",
murders_beat$placename,
".
<br>
<table>      
      <tr>
				<th></th>
				<th>Total</th>
				<th>Rate</th>
			</tr>
			<tr>
				<td>2019</td>
				<td>",
murders_beat$total19,
"</td>
				<td>",
murders_beat$rate19,
"</td>
			</tr>
			<tr>
				<td>2020</td>
				<td>",
murders_beat$total20,
"</td>
				<td>",
murders_beat$rate20,
"</td>
			</tr>
						<tr>
				<td>2021</td>
				<td>",
murders_beat$total21,
"</td>
				<td>",
murders_beat$rate21,
"</td>
			</tr>
						<tr>
				<td>Last 12 months</td>
				<td>",
murders_beat$last12mos,
"</td>
				<td>",
murders_beat$rate_last12,
"</td>
			</tr>
						<tr>
				<td>3-year Average</td>
				<td>",
murders_beat$avg_prior3years,
"</td>
				<td>",
murders_beat$rate_prior3years,
"</td>
			</tr>
</table>")

# Creating police beats map for types of crimes
houston_murder_map <- leaflet(murders_beat, options = leafletOptions(zoomControl = FALSE, zoomSnap = 0.5, zoomDelta=0.5)) %>%
  htmlwidgets::onRender("function(el, x) {
L.control.zoom({ position: 'topright' }).addTo(this)
}") %>%
  setView(-95.45, 29.75, zoom = 10.5) %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(color = "white", 
              popup = murderlabel,
              popupOptions = popupOptions(maxWidth ="200", 
                                          minWidth ="200"),
              weight = 2, 
              smoothFactor = 0.5,
              opacity = 0.6, 
              fillOpacity = 0.5,
              fillColor = ~murderpal(rate_last12)) %>% 
  addSearchOSM(options = searchOptions(autoCollapse=FALSE, minLength = 3,zoom=13, position="topleft")) %>%
    onRender("function(el, x) {
        $('input.search-input')[0].placeholder = 'Search street, place or zip code'
        }") %>%
  addLegend(opacity = 0.6,
            values = murders_beat$rate_last12, 
            colors = c("#667f99",
                       "#00318b",
                       "#0058f6",
                       "#ffba00",
                       "#be0000"),
            labels=c("Lowest Rate", 
                     "Lower Rate", 
                     "High Rate", 
                     "Higher Rate",
                     "Highest Rate"),
            position = "bottomleft", 
            title = "<popuptitle>Homicides")  

houston_murder_map
```
<br>
About <h8>`r round(pop_murdersmonthly/2304580*100,0)`%</h8> of people live where there was at least one murder a month over the last year.
<br>
<br>
<!-- <subhead>Homicides month by month, 2019 through last month</subhead> -->

<iframe title="Homicides month by month, 2019 through last month" aria-label="Column Chart" id="datawrapper-chart-3NHzG" src="https://datawrapper.dwcdn.net/3NHzG/5/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="400" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
  <br>
<br>

<!-- <subhead>What kinds of places do murders happen in Houston</subhead> -->

<iframe title="What kinds of places do murders happen in Houston"  aria-label="Table" id="datawrapper-chart-xI2y0" src="https://datawrapper.dwcdn.net/xI2y0/14/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="1239" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
<br>
<br>
<!-- <subhead>What time of day do murders happen?</subhead> -->

<iframe title="What hour of day do murders happen" aria-label="Column Chart" id="datawrapper-chart-coxAA" src="https://datawrapper.dwcdn.net/coxAA/7/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="400" data-external="1"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();
</script>
